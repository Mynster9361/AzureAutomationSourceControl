name: Sync Azure Automation Runbooks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-runbooks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Important to fetch all history for proper diffs

    - name: Get changed files
      id: changed-files
      run: |
        # Different approach based on event type
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # For pull requests, compare base and head commits
          echo "Getting changes from PR"
          DIFF_OUTPUT=$(git diff --name-status ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          # For pushes, compare previous and current commits
          echo "Getting changes from push"
          if [[ -n "${{ github.event.before }}" && "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
            DIFF_OUTPUT=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }})
          else
            # First push to branch case - compare with the first parent commit
            echo "First push to branch, getting all files"
            DIFF_OUTPUT=$(git diff --name-status $(git rev-parse HEAD^) ${{ github.sha }})
          fi
        else
          # For workflow_dispatch or other events, list all files
          echo "Manual workflow run, getting all files"
          DIFF_OUTPUT=$(find . -type f -not -path "*/\.*" -not -path "*/node_modules/*" | sed 's/^\.\//A /')
        fi

        # Process renamed files specially - extract additions and deletions from them
        # Format of rename: R100 oldfile newfile
        RENAMED_FROM=$(echo "$DIFF_OUTPUT" | grep -E '^R[0-9]+' | awk '{print "D " $2}' || echo '')
        RENAMED_TO=$(echo "$DIFF_OUTPUT" | grep -E '^R[0-9]+' | awk '{print "A " $3}' || echo '')

        # Extract regular added/modified and deleted files
        REGULAR_ADDED_MODIFIED=$(echo "$DIFF_OUTPUT" | grep -E '^[AM]' || echo '')
        REGULAR_DELETED=$(echo "$DIFF_OUTPUT" | grep -E '^D' || echo '')

        # Combine regular changes with rename-derived changes
        ADDED_MODIFIED=$(echo -e "$REGULAR_ADDED_MODIFIED\n$RENAMED_TO" | grep -v '^$')
        DELETED=$(echo -e "$REGULAR_DELETED\n$RENAMED_FROM" | grep -v '^$')

        # Convert to environment variables for easier handling
        echo "added_modified_files<<EOF" >> $GITHUB_ENV
        echo "$ADDED_MODIFIED" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        echo "deleted_files<<EOF" >> $GITHUB_ENV
        echo "$DELETED" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        # Display changes for debugging
        echo "Changes detected:"
        echo "$DIFF_OUTPUT"

        echo "Processed changes:"
        echo "Added/Modified:"
        echo "$ADDED_MODIFIED"
        echo "Deleted:"
        echo "$DELETED"

    - name: Display changed files
      run: |
        echo "Added or Modified files:"
        echo "$added_modified_files"
        echo "----------------------"
        echo "Deleted files:"
        echo "$deleted_files"

    # Here you would add the Azure login and runbook sync steps
    # - name: Login to Azure
    #   uses: azure/login@v1
    #   with:
    #     creds: ${{ secrets.AZURE_CREDENTIALS }}

    # - name: Sync Azure Automation Runbooks
    #   uses: ./  # Assumes the action is in the root of this repository
    #   with:
    #     subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    #     resource_group: ${{ secrets.RESOURCE_GROUP_NAME }}
    #     automation_account: ${{ secrets.AUTOMATION_ACCOUNT_NAME }}
    #     runbooks_path: "."  # Or your specific path
    #     sync_mode: "Changed"  # Only process changed files
    #     delete_mode: "OnlyDeleted"  # Only delete files explicitly removed